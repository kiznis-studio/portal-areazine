---
interface Props {
  climate: {
    station: string;
    stationName: string;
    distanceMi: number;
    source: string;
    monthly: Record<string, { avgTemp: number; highTemp: number; lowTemp: number; precip: number }>;
    annual: { avgTemp: number; highTemp: number; lowTemp: number; totalPrecip: number; hotMonths: number; coldMonths: number };
  };
}

const { climate } = Astro.props;
const months = ['jan', 'feb', 'mar', 'apr', 'may', 'jun', 'jul', 'aug', 'sep', 'oct', 'nov', 'dec'];
const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

// Find temperature range for bar scaling
const allTemps = months.map(m => climate.monthly[m]).filter(d => d && d.lowTemp != null && d.highTemp != null);
const minTemp = allTemps.length > 0 ? Math.min(...allTemps.map(m => m.lowTemp)) : 0;
const maxTemp = allTemps.length > 0 ? Math.max(...allTemps.map(m => m.highTemp)) : 100;
const tempRange = maxTemp - minTemp || 1;
---

<section class="mb-12">
  <div class="flex items-baseline gap-3 mb-4">
    <h2 class="text-xs font-bold uppercase tracking-wider text-[var(--color-muted)]">Climate</h2>
    <span class="text-xs text-[var(--color-muted)] opacity-60">NOAA 1991-2020 Normals</span>
  </div>

  {/* Annual Summary */}
  <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6">
    <div class="p-3 rounded-lg border border-[var(--color-border)] bg-[var(--color-card)]">
      <div class="text-xs text-[var(--color-muted)] mb-1 flex items-center gap-1.5">
        <svg class="w-3.5 h-3.5 text-[var(--color-data-red)] flex-shrink-0" viewBox="0 0 16 16" fill="none">
          <rect x="6" y="1" width="4" height="10" rx="2" stroke="currentColor" stroke-width="1.3"/>
          <circle cx="8" cy="13" r="2.5" stroke="currentColor" stroke-width="1.3"/>
          <line x1="8" y1="7" x2="8" y2="11" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
        Avg Temperature
      </div>
      <div class="text-xl font-black tabular-nums">{climate.annual.avgTemp != null ? `${climate.annual.avgTemp.toFixed(0)}°F` : '—'}</div>
    </div>
    <div class="p-3 rounded-lg border border-[var(--color-border)] bg-[var(--color-card)]">
      <div class="text-xs text-[var(--color-muted)] mb-1 flex items-center gap-1.5">
        <svg class="w-3.5 h-3.5 text-[var(--color-data-blue)] flex-shrink-0" viewBox="0 0 16 16" fill="none">
          <path d="M8 2C8 2 4 7.5 4 10a4 4 0 0 0 8 0C12 7.5 8 2 8 2Z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/>
          <path d="M6.5 10.5a1.5 1.5 0 0 0 1.5 1.5" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </svg>
        Annual Rainfall
      </div>
      <div class="text-xl font-black tabular-nums">{climate.annual.totalPrecip != null ? `${climate.annual.totalPrecip.toFixed(1)}"` : 'N/A'}</div>
    </div>
    <div class="p-3 rounded-lg border border-[var(--color-border)] bg-[var(--color-card)]">
      <div class="text-xs text-[var(--color-muted)] mb-1 flex items-center gap-1.5">
        <svg class="w-3.5 h-3.5 text-[var(--color-data-amber)] flex-shrink-0" viewBox="0 0 16 16" fill="none">
          <circle cx="8" cy="8" r="3" stroke="currentColor" stroke-width="1.3"/>
          <line x1="8" y1="1.5" x2="8" y2="3.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="8" y1="12.5" x2="8" y2="14.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="1.5" y1="8" x2="3.5" y2="8" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="12.5" y1="8" x2="14.5" y2="8" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="3.4" y1="3.4" x2="4.8" y2="4.8" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="11.2" y1="11.2" x2="12.6" y2="12.6" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="3.4" y1="12.6" x2="4.8" y2="11.2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="11.2" y1="4.8" x2="12.6" y2="3.4" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
        Hot Months (&gt;80°F)
      </div>
      <div class="text-xl font-black tabular-nums">{climate.annual.hotMonths ?? '—'}</div>
    </div>
    <div class="p-3 rounded-lg border border-[var(--color-border)] bg-[var(--color-card)]">
      <div class="text-xs text-[var(--color-muted)] mb-1 flex items-center gap-1.5">
        <svg class="w-3.5 h-3.5 text-[var(--color-data-teal)] flex-shrink-0" viewBox="0 0 16 16" fill="none">
          <line x1="8" y1="1" x2="8" y2="15" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="1" y1="8" x2="15" y2="8" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="3.1" y1="3.1" x2="12.9" y2="12.9" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="12.9" y1="3.1" x2="3.1" y2="12.9" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/>
          <line x1="5" y1="2" x2="11" y2="14" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
          <line x1="11" y1="2" x2="5" y2="14" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
        </svg>
        Cold Months (&lt;40°F)
      </div>
      <div class="text-xl font-black tabular-nums">{climate.annual.coldMonths ?? '—'}</div>
    </div>
  </div>

  {/* Monthly Temperature Chart (CSS bars) */}
  <div class="overflow-x-auto">
    <div class="grid grid-cols-12 gap-1 min-w-[600px]">
      {months.map((m, i) => {
        const data = climate.monthly[m];
        if (!data || data.highTemp == null || data.lowTemp == null) return null;
        const lowPct = ((data.lowTemp - minTemp) / tempRange) * 100;
        const highPct = ((data.highTemp - minTemp) / tempRange) * 100;
        const barBottom = lowPct;
        const barHeight = highPct - lowPct;
        return (
          <div class="flex flex-col items-center text-center">
            <div class="text-xs text-[var(--color-muted)] mb-1 tabular-nums">{data.highTemp.toFixed(0)}°</div>
            <div class="relative w-full h-24 bg-[var(--color-card)] rounded border border-[var(--color-border)]">
              <div
                class="absolute left-1 right-1 rounded"
                style={`bottom: ${barBottom}%; height: ${barHeight}%; background: linear-gradient(to top, var(--color-data-blue), var(--color-data-red));`}
              />
            </div>
            <div class="text-xs text-[var(--color-muted)] mt-1 tabular-nums">{data.lowTemp.toFixed(0)}°</div>
            <div class="text-xs font-medium mt-0.5">{monthLabels[i]}</div>
            <div class="text-xs text-[var(--color-muted)] tabular-nums">{data.precip != null ? `${data.precip.toFixed(1)}"` : '—'}</div>
          </div>
        );
      })}
    </div>
  </div>
</section>
