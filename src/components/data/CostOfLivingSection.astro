---
interface Props {
  costOfLiving: {
    rpp: number;
    year: string | number;
    msaName: string;
    source: string;
    description: string;
  };
}

const { costOfLiving } = Astro.props;
const rpp = costOfLiving.rpp;
const diff = rpp - 100;
const isAbove = diff > 0;
const diffPct = Math.abs(diff).toFixed(1);
// Bar width: scale RPP 80–130 to 0–100%
const barPct = Math.min(100, Math.max(0, ((rpp - 80) / 50) * 100));
const natPct = ((100 - 80) / 50) * 100; // national avg at RPP=100
---

<section class="mb-12">
  <div class="flex items-baseline gap-3 mb-4">
    <h2 class="text-xs font-bold uppercase tracking-wider text-[var(--color-muted)]">Cost of Living</h2>
    <span class="text-xs text-[var(--color-muted)] opacity-60">BEA {costOfLiving.year}</span>
  </div>

  <div class="border border-[var(--color-border)] rounded-xl p-5">
    <div class="flex items-baseline gap-3 mb-1">
      <span class="text-3xl font-black tabular-nums">{rpp.toFixed(1)}</span>
      <span class="text-sm text-[var(--color-muted)]">Regional Price Parity</span>
    </div>
    <p class="text-sm mb-4">
      <span class={isAbove ? 'text-[var(--color-data-red)]' : 'text-[var(--color-data-teal)]'}>
        {isAbove ? `${diffPct}% above` : `${diffPct}% below`} national average
      </span>
    </p>

    {/* Visual bar */}
    <div class="relative h-6 bg-[var(--color-card)] rounded border border-[var(--color-border)] mb-3 mt-5">
      {/* Fill from left to RPP position */}
      <div
        class="absolute top-0 bottom-0 left-0 rounded-l"
        style={`width: ${barPct}%; background: ${isAbove ? 'var(--color-data-red)' : 'var(--color-data-teal)'}; opacity: 0.15;`}
      />
      {/* Colored segment showing delta from national avg */}
      {isAbove ? (
        <div
          class="absolute top-0 bottom-0 rounded-sm"
          style={`left: ${natPct}%; width: ${barPct - natPct}%; background: var(--color-data-red); opacity: 0.5;`}
        />
      ) : (
        <div
          class="absolute top-0 bottom-0 rounded-sm"
          style={`left: ${barPct}%; width: ${natPct - barPct}%; background: var(--color-data-teal); opacity: 0.5;`}
        />
      )}
      {/* National avg marker */}
      <div
        class="absolute top-0 bottom-0 w-px bg-[var(--color-muted)]"
        style={`left: ${natPct}%;`}
      />
      <span class="absolute text-[10px] text-[var(--color-muted)] tabular-nums" style={`left: ${natPct}%; top: -18px; transform: translateX(-50%);`}>
        US avg
      </span>
      {/* City RPP position marker */}
      <div
        class="absolute top-0 bottom-0 w-0.5 rounded"
        style={`left: ${barPct}%; background: ${isAbove ? 'var(--color-data-red)' : 'var(--color-data-teal)'};`}
      />
      <span class="absolute text-[10px] font-semibold tabular-nums" style={`left: ${barPct}%; top: -18px; transform: translateX(-50%); color: ${isAbove ? 'var(--color-data-red)' : 'var(--color-data-teal)'};`}>
        {rpp.toFixed(1)}
      </span>
    </div>

    <p class="text-xs text-[var(--color-muted)]">
      Metro area: {costOfLiving.msaName}
    </p>
    <p class="text-xs text-[var(--color-muted)] mt-1 opacity-60">
      Source: {costOfLiving.source}. RPP of 100 = national average.
    </p>
  </div>
</section>
