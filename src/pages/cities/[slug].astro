---
import Base from '../../layouts/Base.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import SectionHeader from '../../components/ui/SectionHeader.astro';
import StatCard from '../../components/data/StatCard.astro';
import ComparisonIndicator from '../../components/data/ComparisonIndicator.astro';
import ComparisonBar from '../../components/data/ComparisonBar.astro';
import DemographicsChart from '../../components/data/DemographicsChart.astro';
import HealthMetricRow from '../../components/data/HealthMetricRow.astro';
import HospitalRatingDist from '../../components/data/HospitalRatingDist.astro';
import HospitalCard from '../../components/data/HospitalCard.astro';
import DataSourceFooter from '../../components/data/DataSourceFooter.astro';
import CrimeSection from '../../components/data/CrimeSection.astro';
import HistoricalTrends from '../../components/data/HistoricalTrends.astro';
import { CITIES, getNearbyCities } from '../../data/cities';
import { getCollection } from 'astro:content';
import { getCategoryMeta, SITE_NAME } from '../../lib/config';
import type { CategoryKey } from '../../lib/config';
import { fmt, fmtMoney, fmtPct, fmtCompact } from '../../lib/format';

// Import all city profiles at build time
const profileModules = import.meta.glob('../../data/city-profiles/**/*.json', { eager: true }) as Record<string, { default: any }>;
const profiles: Record<string, any> = {};
for (const [path, mod] of Object.entries(profileModules)) {
  const slug = path.split('/').pop()?.replace('.json', '') || '';
  profiles[slug] = mod.default ?? mod;
}

export function getStaticPaths() {
  const maxTier = parseInt(import.meta.env.CITY_TIER || '2');
  return CITIES
    .filter(c => c.tier <= maxTier)
    .map(city => ({
      params: { slug: city.slug },
      props: { city },
    }));
}

const { city } = Astro.props;
const profile = profiles[city.slug] || null;
const census = profile?.census;
const health = profile?.health;
const hospitalData = profile?.hospitals;
const crimeData = profile?.crime;
const historyData = profile?.history;

// Related articles
const allArticles = await getCollection('articles');
const cityTerms = [
  city.name.toLowerCase(),
  city.state.toLowerCase(),
  city.stateCode.toLowerCase(),
  city.countyName.toLowerCase().replace(' county', ''),
];
const relatedArticles = allArticles
  .filter(a => {
    const loc = (a.data.location || '').toLowerCase();
    return cityTerms.some(term => loc.includes(term));
  })
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 6);

// Health measures sorted by severity
const healthConcerns = health?.measures
  ? Object.entries(health.measures)
    .filter(([id]) => !['CHECKUP', 'DENTAL'].includes(id))
    .map(([id, m]: [string, any]) => ({ id, ...m }))
    .sort((a: any, b: any) => b.value - a.value)
  : [];

const healthPositive = health?.measures
  ? Object.entries(health.measures)
    .filter(([id]) => ['CHECKUP', 'DENTAL'].includes(id))
    .map(([id, m]: [string, any]) => ({ id, ...m }))
  : [];

// Hospital rating distribution
const ratingDist = [5, 4, 3, 2, 1].map(r => ({
  rating: r,
  count: (hospitalData?.hospitals || []).filter((h: any) => h.rating === r).length,
}));

// Nearby cities
const nearby = getNearbyCities(city.lat, city.lng, 8, city.slug);

// Page meta
const pageTitle = `${city.name}, ${city.stateCode} — City Data Report`;
const pageDesc = `${city.name}, ${city.stateCode}: population ${fmt(census?.population)}, median income ${fmtMoney(census?.medianHouseholdIncome)}, health data, hospitals. Official U.S. government sources.`;

// Summary highlights for hero
const highlights: string[] = [];
if (census) {
  highlights.push(`Population ${fmtCompact(census.population)}`);
  highlights.push(`Median income ${fmtMoney(census.medianHouseholdIncome)}`);
}
if (hospitalData?.totalHospitals) {
  highlights.push(`${hospitalData.totalHospitals} hospital${hospitalData.totalHospitals > 1 ? 's' : ''}`);
}

const stateSlug = city.state.toLowerCase().replace(/\s+/g, '-');
---

<Base title={pageTitle} description={pageDesc}>
  <div class="container py-8 md:py-12">

    <Breadcrumb items={[
      { label: 'Home', href: '/' },
      { label: 'States', href: '/states' },
      { label: city.state, href: `/states/${stateSlug}` },
      { label: city.name },
    ]} />

    {/* Hero */}
    <header class="mb-10">
      <div class="flex items-baseline gap-3 mb-2">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-black tracking-tight">{city.name}</h1>
        <span class="text-base md:text-lg text-[var(--color-muted)] font-medium px-2 py-0.5 bg-[var(--color-card)] rounded">{city.stateCode}</span>
      </div>
      <p class="text-base text-[var(--color-muted)]">
        {city.countyName}, {city.state}
      </p>
      {highlights.length > 0 && (
        <p class="text-sm text-[var(--color-muted)] mt-2 flex flex-wrap gap-x-3 gap-y-1">
          {highlights.map((h, i) => (
            <>
              {i > 0 && <span class="text-[var(--color-border)]">|</span>}
              <span>{h}</span>
            </>
          ))}
        </p>
      )}
    </header>

    {census && (
      <>
        {/* Quick Stats */}
        <section class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-12">
          <StatCard
            label="Population"
            value={fmt(census.population)}
            metric="medianHouseholdIncome"
            subtitle={city.countyName}
            accentColor="var(--color-data-blue)"
          />
          <StatCard
            label="Median Income"
            value={fmtMoney(census.medianHouseholdIncome)}
            metric="medianHouseholdIncome"
            rawValue={census.medianHouseholdIncome}
            accentColor="var(--color-data-teal)"
          />
          <StatCard
            label="Median Home Value"
            value={fmtMoney(census.medianHomeValue)}
            metric="medianHomeValue"
            rawValue={census.medianHomeValue}
            accentColor="var(--color-data-amber)"
          />
          <StatCard
            label="Median Age"
            value={census.medianAge?.toString() || 'N/A'}
            subtitle="years"
            accentColor="var(--color-data-violet)"
          />
        </section>

        {/* 10-Year Trends (if history data available) */}
        {historyData && historyData.years?.length >= 3 && (
          <section class="mb-12">
            <SectionHeader title="10-Year Trends" count={`${historyData.years[0]}–${historyData.years[historyData.years.length - 1]}`} />
            <div class="border border-[var(--color-border)] rounded-xl p-5">
              <HistoricalTrends history={historyData} />
            </div>
          </section>
        )}

        {/* Economics & Demographics */}
        <div class="grid md:grid-cols-2 gap-8 mb-12">

          {/* Economics */}
          <section>
            <SectionHeader title="Economics" />
            <div class="data-table">
              <div class="data-row">
                <span class="text-sm">Median Rent</span>
                <div class="flex items-center gap-2">
                  <ComparisonBar metric="medianRent" value={census.medianRent} />
                  <span class="font-semibold text-sm tabular-nums">{fmtMoney(census.medianRent)}/mo</span>
                </div>
              </div>
              <div class="data-row">
                <span class="text-sm">Poverty Rate</span>
                <div class="flex items-center gap-2">
                  <ComparisonBar metric="povertyRate" value={census.povertyRate} invert />
                  <div class="text-right">
                    <span class="font-semibold text-sm tabular-nums">{fmtPct(census.povertyRate)}</span>
                    <ComparisonIndicator metric="povertyRate" value={census.povertyRate} />
                  </div>
                </div>
              </div>
              <div class="data-row">
                <span class="text-sm">Unemployment</span>
                <span class="font-semibold text-sm tabular-nums">{fmtPct(census.unemploymentRate)}</span>
              </div>
              <div class="data-row">
                <span class="text-sm">Bachelor's Degree+</span>
                <span class="font-semibold text-sm tabular-nums">{fmtPct(census.bachelorDegreeOrHigher)}</span>
              </div>
              <div class="data-row">
                <span class="text-sm">Work From Home</span>
                <span class="font-semibold text-sm tabular-nums">{fmtPct(census.workFromHomePct)}</span>
              </div>
              <div class="data-row">
                <span class="text-sm">Public Transit</span>
                <span class="font-semibold text-sm tabular-nums">{fmtPct(census.publicTransitPct)}</span>
              </div>
            </div>
          </section>

          {/* Demographics */}
          <section>
            <SectionHeader title="Demographics" />
            <div class="border border-[var(--color-border)] rounded-xl p-5">
              <DemographicsChart demographics={census.demographics} />
            </div>
          </section>
        </div>
      </>
    )}

    {/* Health Profile */}
    {healthConcerns.length > 0 && (
      <section class="mb-12">
        <SectionHeader title="Health Profile" count={`${healthConcerns.length + healthPositive.length} measures`} />
        <div class="grid md:grid-cols-2 gap-4">
          <div class="data-table">
            <div class="px-4 py-3 border-b border-[var(--color-border)] bg-[var(--color-card)]">
              <h3 class="text-xs font-semibold uppercase tracking-wider text-[var(--color-muted)]">Health Indicators</h3>
            </div>
            {healthConcerns.slice(0, 10).map((m: any) => (
              <HealthMetricRow label={m.label} value={m.value} unit={m.unit} />
            ))}
          </div>

          <div class="space-y-4">
            {healthPositive.length > 0 && (
              <div class="data-table">
                <div class="px-4 py-3 border-b border-[var(--color-border)] bg-[var(--color-card)]">
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[var(--color-muted)]">Preventive Care</h3>
                </div>
                {healthPositive.map((m: any) => (
                  <div class="data-row">
                    <span class="text-sm">{m.label}</span>
                    <span class="font-semibold text-sm tabular-nums text-[var(--color-above)]">{m.value}{m.unit}</span>
                  </div>
                ))}
              </div>
            )}

            {healthConcerns.length > 10 && (
              <div class="data-table">
                <div class="px-4 py-3 border-b border-[var(--color-border)] bg-[var(--color-card)]">
                  <h3 class="text-xs font-semibold uppercase tracking-wider text-[var(--color-muted)]">Other Measures</h3>
                </div>
                {healthConcerns.slice(10).map((m: any) => (
                  <HealthMetricRow label={m.label} value={m.value} unit={m.unit} />
                ))}
              </div>
            )}
          </div>
        </div>
      </section>
    )}

    {/* Public Safety */}
    {crimeData && crimeData.violentCrimeRate > 0 && (
      <section class="mb-12">
        <SectionHeader title="Public Safety" count={`${crimeData.year} data`} />
        <CrimeSection crime={crimeData} />
      </section>
    )}

    {/* Hospitals */}
    {hospitalData && hospitalData.hospitals.length > 0 && (
      <section class="mb-12">
        <SectionHeader title="Hospitals" count={`${hospitalData.totalHospitals} total`} />

        {/* Rating Distribution */}
        <div class="grid md:grid-cols-3 gap-6 mb-6">
          <div class="border border-[var(--color-border)] rounded-xl p-5">
            <div class="data-label mb-2">Rating Distribution</div>
            <HospitalRatingDist ratings={ratingDist} total={hospitalData.totalHospitals} />
          </div>
          <div class="md:col-span-2 border border-[var(--color-border)] rounded-xl p-5 flex items-center gap-6">
            <div>
              <div class="data-label mb-1">Average Rating</div>
              <div class="data-value text-[var(--color-data-amber)]">{hospitalData.averageRating}<span class="text-base font-normal text-[var(--color-muted)]">/5</span></div>
            </div>
            <div>
              <div class="data-label mb-1">Total Hospitals</div>
              <div class="data-value">{hospitalData.totalHospitals}</div>
            </div>
            <div>
              <div class="data-label mb-1">With ER</div>
              <div class="data-value">{hospitalData.hospitals.filter((h: any) => h.emergency).length}</div>
            </div>
          </div>
        </div>

        {/* Hospital List */}
        <div class="data-table">
          {hospitalData.hospitals.map((h: any) => (
            <HospitalCard
              name={h.name}
              city={h.city}
              type={h.type}
              rating={h.rating}
              emergency={h.emergency}
            />
          ))}
        </div>
      </section>
    )}

    {/* Related Articles */}
    {relatedArticles.length > 0 && (
      <section class="section-divider mb-12">
        <SectionHeader title={`Alerts & News — ${city.name} Area`} count={relatedArticles.length} />
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {relatedArticles.map(article => (
            <ArticleCard
              title={article.data.title}
              summary={article.data.summary}
              href={`/${getCategoryMeta(article.data.category as CategoryKey).slug}/${article.id}`}
              category={article.data.category as CategoryKey}
              sourceAgency={article.data.sourceAgency}
              publishedAt={new Date(article.data.publishedAt)}
              severity={article.data.severity}
              location={article.data.location}
            />
          ))}
        </div>
      </section>
    )}

    {/* Nearby Cities */}
    <section class="section-divider">
      <SectionHeader title="Nearby Cities" count={nearby.length} />
      <div class="flex flex-wrap gap-2">
        {nearby.map(c => (
          <a
            href={`/cities/${c.slug}`}
            class="text-sm px-3 py-1.5 border border-[var(--color-border)] rounded-full hover:border-[var(--color-muted)] hover:bg-[var(--color-card)] transition-colors flex items-center gap-2"
          >
            <span>{c.name}, {c.stateCode}</span>
            <span class="text-xs text-[var(--color-muted)] tabular-nums">{fmtCompact(c.population)}</span>
          </a>
        ))}
      </div>
      <div class="mt-4 flex gap-4">
        <a href={`/states/${stateSlug}`} class="text-sm text-[var(--color-accent)] hover:underline">All cities in {city.state} &rarr;</a>
        <a href="/cities" class="text-sm text-[var(--color-muted)] hover:text-[var(--color-foreground)]">Browse all cities</a>
      </div>
    </section>

    {/* Data Sources */}
    <DataSourceFooter county={city.countyName} />
  </div>

  {/* Structured Data */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "City",
    "name": city.name,
    "containedInPlace": { "@type": "State", "name": city.state },
    "geo": { "@type": "GeoCoordinates", "latitude": city.lat, "longitude": city.lng },
    ...(census && {
      "description": `${city.name}, ${city.stateCode} has a population of ${fmt(census.population)} (${city.countyName}) with a median household income of ${fmtMoney(census.medianHouseholdIncome)}.`,
    }),
  })} />

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://areazine.com/" },
      { "@type": "ListItem", "position": 2, "name": "States", "item": "https://areazine.com/states/" },
      { "@type": "ListItem", "position": 3, "name": city.state, "item": `https://areazine.com/states/${stateSlug}` },
      { "@type": "ListItem", "position": 4, "name": `${city.name}, ${city.stateCode}` },
    ],
  })} />
</Base>
