---
import Base from '../../layouts/Base.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { CITIES } from '../../data/cities';
import { getCollection } from 'astro:content';
import { getCategoryMeta, SITE_NAME } from '../../lib/config';
import type { CategoryKey } from '../../lib/config';

// Import all city profiles at build time via Vite glob
const profileModules = import.meta.glob('../../data/city-profiles/*.json', { eager: true }) as Record<string, { default: any }>;

const profiles: Record<string, any> = {};
for (const [path, mod] of Object.entries(profileModules)) {
  const slug = path.split('/').pop()?.replace('.json', '') || '';
  profiles[slug] = mod.default ?? mod;
}

export function getStaticPaths() {
  return CITIES.map(city => ({
    params: { slug: city.slug },
    props: { city },
  }));
}

const { city } = Astro.props;

// Load pre-fetched profile data
const profile = profiles[city.slug] || null;

const census = profile?.census;
const health = profile?.health;
const hospitalData = profile?.hospitals;

// Find related articles (match city name, state, or county in location field)
const allArticles = await getCollection('articles');
const cityTerms = [
  city.name.toLowerCase(),
  city.state.toLowerCase(),
  city.stateCode.toLowerCase(),
  city.countyName.toLowerCase().replace(' county', ''),
];
const relatedArticles = allArticles
  .filter(a => {
    const loc = (a.data.location || '').toLowerCase();
    return cityTerms.some(term => loc.includes(term));
  })
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 6);

// Format helpers
function fmt(n: number | null | undefined): string {
  if (n == null) return 'N/A';
  return n.toLocaleString('en-US');
}
function fmtPct(n: number | null | undefined): string {
  if (n == null) return 'N/A';
  return `${n}%`;
}
function fmtMoney(n: number | null | undefined): string {
  if (n == null) return 'N/A';
  return `$${n.toLocaleString('en-US')}`;
}

// Health measures sorted by severity (highest rates first, excluding positive metrics)
const healthConcerns = health?.measures
  ? Object.entries(health.measures)
    .filter(([id]) => !['CHECKUP', 'DENTAL'].includes(id)) // Exclude positive metrics
    .map(([id, m]: [string, any]) => ({ id, ...m }))
    .sort((a: any, b: any) => b.value - a.value)
  : [];

const healthPositive = health?.measures
  ? Object.entries(health.measures)
    .filter(([id]) => ['CHECKUP', 'DENTAL'].includes(id))
    .map(([id, m]: [string, any]) => ({ id, ...m }))
  : [];

// Hospital rating distribution
const ratingDist = [5, 4, 3, 2, 1].map(r => ({
  rating: r,
  count: (hospitalData?.hospitals || []).filter((h: any) => h.rating === r).length,
}));

const pageTitle = `${city.name}, ${city.stateCode} — City Data Report`;
const pageDesc = `${city.name}, ${city.stateCode} city profile: population ${fmt(census?.population)}, median income ${fmtMoney(census?.medianHouseholdIncome)}, health data, hospitals, and safety alerts from official U.S. government sources.`;

// Star rendering helper
function stars(rating: number): string {
  return '★'.repeat(rating) + '☆'.repeat(5 - rating);
}
---

<Base title={pageTitle} description={pageDesc}>
  <div class="container py-8 md:py-12">
    {/* Breadcrumb */}
    <nav class="flex items-center gap-2 text-sm text-[var(--color-muted)] mb-6">
      <a href="/" class="hover:text-[var(--color-foreground)]">Home</a>
      <span>/</span>
      <a href="/cities" class="hover:text-[var(--color-foreground)]">Cities</a>
      <span>/</span>
      <span class="text-[var(--color-foreground)]">{city.name}</span>
    </nav>

    {/* Hero */}
    <header class="mb-10">
      <div class="flex items-baseline gap-3 mb-2">
        <h1 class="text-3xl md:text-4xl lg:text-5xl font-black tracking-tight">{city.name}</h1>
        <span class="text-lg md:text-xl text-[var(--color-muted)] font-medium">{city.stateCode}</span>
      </div>
      <p class="text-lg text-[var(--color-muted)] max-w-2xl">
        {city.countyName}, {city.state} — Government data from Census Bureau, CDC, and CMS.
      </p>
    </header>

    {census && (
      <>
        {/* Quick Stats Grid */}
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
          <div class="border border-[var(--color-border)] rounded-lg p-4">
            <div class="text-xs font-medium text-[var(--color-muted)] uppercase tracking-wider mb-1">Population</div>
            <div class="text-2xl font-bold">{fmt(census.population)}</div>
            <div class="text-xs text-[var(--color-muted)]">{city.countyName}</div>
          </div>
          <div class="border border-[var(--color-border)] rounded-lg p-4">
            <div class="text-xs font-medium text-[var(--color-muted)] uppercase tracking-wider mb-1">Median Income</div>
            <div class="text-2xl font-bold">{fmtMoney(census.medianHouseholdIncome)}</div>
            <div class="text-xs text-[var(--color-muted)]">per household/year</div>
          </div>
          <div class="border border-[var(--color-border)] rounded-lg p-4">
            <div class="text-xs font-medium text-[var(--color-muted)] uppercase tracking-wider mb-1">Median Home</div>
            <div class="text-2xl font-bold">{fmtMoney(census.medianHomeValue)}</div>
            <div class="text-xs text-[var(--color-muted)]">home value</div>
          </div>
          <div class="border border-[var(--color-border)] rounded-lg p-4">
            <div class="text-xs font-medium text-[var(--color-muted)] uppercase tracking-wider mb-1">Median Age</div>
            <div class="text-2xl font-bold">{census.medianAge}</div>
            <div class="text-xs text-[var(--color-muted)]">years</div>
          </div>
        </section>

        {/* Economics & Demographics */}
        <div class="grid md:grid-cols-2 gap-8 mb-12">
          {/* Economics */}
          <section>
            <h2 class="text-sm font-bold uppercase tracking-wider text-[var(--color-muted)] mb-4">Economics</h2>
            <div class="border border-[var(--color-border)] rounded-lg divide-y divide-[var(--color-border)]">
              <div class="flex justify-between items-center p-4">
                <span class="text-sm">Median Rent</span>
                <span class="font-semibold">{fmtMoney(census.medianRent)}/mo</span>
              </div>
              <div class="flex justify-between items-center p-4">
                <span class="text-sm">Poverty Rate</span>
                <span class="font-semibold">{fmtPct(census.povertyRate)}</span>
              </div>
              <div class="flex justify-between items-center p-4">
                <span class="text-sm">Unemployment</span>
                <span class="font-semibold">{fmtPct(census.unemploymentRate)}</span>
              </div>
              <div class="flex justify-between items-center p-4">
                <span class="text-sm">Bachelor's Degree+</span>
                <span class="font-semibold">{fmtPct(census.bachelorDegreeOrHigher)}</span>
              </div>
              <div class="flex justify-between items-center p-4">
                <span class="text-sm">Work From Home</span>
                <span class="font-semibold">{fmtPct(census.workFromHomePct)}</span>
              </div>
              <div class="flex justify-between items-center p-4">
                <span class="text-sm">Public Transit</span>
                <span class="font-semibold">{fmtPct(census.publicTransitPct)}</span>
              </div>
            </div>
            <p class="text-xs text-[var(--color-muted)] mt-2">Source: {census.source}</p>
          </section>

          {/* Demographics */}
          <section>
            <h2 class="text-sm font-bold uppercase tracking-wider text-[var(--color-muted)] mb-4">Demographics</h2>
            <div class="border border-[var(--color-border)] rounded-lg p-4">
              <div class="space-y-3">
                {Object.entries(census.demographics).map(([group, pct]: [string, any]) => (
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="capitalize">{group === 'other' ? 'Other / Multiracial' : group}</span>
                      <span class="font-semibold">{pct}%</span>
                    </div>
                    <div class="w-full bg-[var(--color-card)] rounded-full h-2">
                      <div
                        class="bg-[var(--color-accent)] rounded-full h-2 transition-all"
                        style={`width: ${Math.min(pct, 100)}%; opacity: ${0.4 + (pct / 100) * 0.6}`}
                      />
                    </div>
                  </div>
                ))}
              </div>
            </div>
            <p class="text-xs text-[var(--color-muted)] mt-2">Source: {census.source}</p>
          </section>
        </div>
      </>
    )}

    {/* Health Profile */}
    {healthConcerns.length > 0 && (
      <section class="mb-12">
        <h2 class="text-sm font-bold uppercase tracking-wider text-[var(--color-muted)] mb-4">Health Profile</h2>
        <div class="grid md:grid-cols-2 gap-4">
          {/* Health Concerns */}
          <div class="border border-[var(--color-border)] rounded-lg">
            <div class="p-4 border-b border-[var(--color-border)]">
              <h3 class="font-semibold text-sm">Health Indicators</h3>
            </div>
            <div class="divide-y divide-[var(--color-border)]">
              {healthConcerns.slice(0, 10).map((m: any) => (
                <div class="flex justify-between items-center p-4">
                  <span class="text-sm">{m.label}</span>
                  <span class:list={[
                    "font-semibold text-sm px-2 py-0.5 rounded",
                    m.value >= 30 ? "text-[var(--severity-high)] bg-[rgba(220,38,38,0.08)]" :
                    m.value >= 20 ? "text-[var(--severity-medium)] bg-[rgba(217,119,6,0.08)]" :
                    "text-[var(--color-foreground)]"
                  ]}>
                    {m.value}{m.unit}
                  </span>
                </div>
              ))}
            </div>
          </div>

          {/* Preventive Care */}
          <div>
            {healthPositive.length > 0 && (
              <div class="border border-[var(--color-border)] rounded-lg mb-4">
                <div class="p-4 border-b border-[var(--color-border)]">
                  <h3 class="font-semibold text-sm">Preventive Care</h3>
                </div>
                <div class="divide-y divide-[var(--color-border)]">
                  {healthPositive.map((m: any) => (
                    <div class="flex justify-between items-center p-4">
                      <span class="text-sm">{m.label}</span>
                      <span class="font-semibold text-sm">{m.value}{m.unit}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {healthConcerns.length > 10 && (
              <div class="border border-[var(--color-border)] rounded-lg">
                <div class="p-4 border-b border-[var(--color-border)]">
                  <h3 class="font-semibold text-sm">Other Measures</h3>
                </div>
                <div class="divide-y divide-[var(--color-border)]">
                  {healthConcerns.slice(10).map((m: any) => (
                    <div class="flex justify-between items-center p-4">
                      <span class="text-sm">{m.label}</span>
                      <span class="font-semibold text-sm">{m.value}{m.unit}</span>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
        <p class="text-xs text-[var(--color-muted)] mt-2">Source: {health?.source}</p>
      </section>
    )}

    {/* Hospitals */}
    {hospitalData && hospitalData.hospitals.length > 0 && (
      <section class="mb-12">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-bold uppercase tracking-wider text-[var(--color-muted)]">Hospitals</h2>
          <span class="text-sm text-[var(--color-muted)]">
            {hospitalData.totalHospitals} total &middot; Avg rating {hospitalData.averageRating}/5
          </span>
        </div>

        <div class="border border-[var(--color-border)] rounded-lg divide-y divide-[var(--color-border)]">
          {hospitalData.hospitals.map((h: any) => (
            <div class="p-4 flex items-start justify-between gap-4">
              <div>
                <div class="font-semibold text-sm">{h.name}</div>
                <div class="text-xs text-[var(--color-muted)]">
                  {h.city} &middot; {h.type}
                  {h.emergency && <span class="ml-1 text-[var(--cat-weather)]">&middot; ER</span>}
                </div>
              </div>
              <div class="flex-shrink-0 text-right">
                <div class="text-amber-500 text-sm tracking-wider" title={`${h.rating} out of 5 stars`}>{stars(h.rating)}</div>
                <div class="text-xs text-[var(--color-muted)]">{h.rating}/5</div>
              </div>
            </div>
          ))}
        </div>
        <p class="text-xs text-[var(--color-muted)] mt-2">Source: {hospitalData.source}</p>
      </section>
    )}

    {/* Related Articles */}
    {relatedArticles.length > 0 && (
      <section class="mb-12 pt-8 border-t border-[var(--color-border)]">
        <h2 class="text-sm font-bold uppercase tracking-wider text-[var(--color-muted)] mb-4">
          Recent Alerts &amp; News — {city.name} Area
        </h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {relatedArticles.map(article => (
            <ArticleCard
              title={article.data.title}
              summary={article.data.summary}
              href={`/${getCategoryMeta(article.data.category as CategoryKey).slug}/${article.id}`}
              category={article.data.category as CategoryKey}
              sourceAgency={article.data.sourceAgency}
              publishedAt={new Date(article.data.publishedAt)}
              severity={article.data.severity}
              location={article.data.location}
            />
          ))}
        </div>
      </section>
    )}

    {/* Browse Other Cities */}
    <section class="pt-8 border-t border-[var(--color-border)]">
      <h2 class="text-sm font-bold uppercase tracking-wider text-[var(--color-muted)] mb-4">Explore Other Cities</h2>
      <div class="flex flex-wrap gap-2">
        {CITIES.filter(c => c.slug !== city.slug).map(c => (
          <a
            href={`/cities/${c.slug}`}
            class="text-sm px-3 py-1.5 border border-[var(--color-border)] rounded-full hover:border-[var(--color-muted)] transition-colors"
          >
            {c.name}, {c.stateCode}
          </a>
        ))}
      </div>
    </section>

    {/* Data Sources */}
    <section class="mt-12 pt-8 border-t border-[var(--color-border)]">
      <h2 class="text-sm font-bold uppercase tracking-wider text-[var(--color-muted)] mb-3">Data Sources</h2>
      <p class="text-sm text-[var(--color-muted)] max-w-2xl">
        All data on this page comes from official U.S. government sources. Demographics and economic data from the
        <a href="https://www.census.gov/programs-surveys/acs" target="_blank" rel="noopener" class="text-[var(--color-accent)] hover:underline">Census Bureau American Community Survey</a> (2022 5-year estimates).
        Health data from the <a href="https://www.cdc.gov/places/" target="_blank" rel="noopener" class="text-[var(--color-accent)] hover:underline">CDC PLACES</a> program (2023).
        Hospital ratings from <a href="https://data.cms.gov/provider-data/" target="_blank" rel="noopener" class="text-[var(--color-accent)] hover:underline">CMS Hospital Compare</a> (2024).
        Data is county-level ({city.countyName}) as the smallest consistent geographic unit across all sources.
      </p>
    </section>
  </div>

  {/* Structured Data — Place */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "City",
    "name": city.name,
    "containedInPlace": {
      "@type": "State",
      "name": city.state,
    },
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": city.lat,
      "longitude": city.lng,
    },
    ...(census && {
      "description": `${city.name}, ${city.stateCode} has a population of ${fmt(census.population)} (${city.countyName}) with a median household income of ${fmtMoney(census.medianHouseholdIncome)}.`,
    }),
  })} />

  {/* Breadcrumb structured data */}
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://areazine.com/" },
      { "@type": "ListItem", "position": 2, "name": "Cities", "item": "https://areazine.com/cities/" },
      { "@type": "ListItem", "position": 3, "name": `${city.name}, ${city.stateCode}` },
    ],
  })} />
</Base>
