---
import Base from '../layouts/Base.astro';
import ArticleCard from '../components/ArticleCard.astro';
import { getCollection } from 'astro:content';
import { SITE_NAME, SITE_DESCRIPTION, getCategoryMeta, getCategoryBadgeClass } from '../lib/config';
import type { CategoryKey } from '../lib/config';
import { CITIES, US_STATES } from '../data/cities';
import { fmt, fmtMoney, fmtCompact } from '../lib/format';
import nationalStats from '../data/national-stats.json';

const allArticles = await getCollection('articles');
const sortedArticles = allArticles.sort((a, b) =>
  new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime()
);

const featured = sortedArticles[0];
const latest = sortedArticles.slice(1, 13); // 12 latest after featured

// Build category sections dynamically — only show categories that have articles
const categoryOrder: CategoryKey[] = [
  'recalls-cpsc', 'recalls-fda', 'recalls-vehicles',
  'weather', 'earthquakes', 'disasters',
  'drug-shortages', 'air-quality',
];

// Group recalls together, keep others separate
const recallArticles = sortedArticles.filter(a => a.data.category.startsWith('recalls-'));
const categorySections = [
  { key: 'recalls' as const, label: 'Recalls', color: 'var(--cat-recalls)', href: '/recalls', articles: recallArticles },
  ...['weather', 'earthquakes', 'disasters', 'drug-shortages', 'air-quality'].map(cat => {
    const articles = sortedArticles.filter(a => a.data.category === cat);
    const meta = getCategoryMeta(cat as CategoryKey);
    return {
      key: cat,
      label: meta.label,
      color: `var(--cat-${meta.color})`,
      href: `/${meta.slug}`,
      articles,
    };
  }),
].filter(s => s.articles.length > 0);

// City data for homepage
const maxTier = parseInt(import.meta.env.CITY_TIER || '2');
const totalCities = CITIES.filter(c => c.tier <= maxTier).length;
const totalPop = CITIES.filter(c => c.tier <= maxTier).reduce((s, c) => s + c.population, 0);
const topCities = CITIES
  .filter(c => c.tier <= maxTier)
  .sort((a, b) => b.population - a.population)
  .slice(0, 12);
---

<Base
  title={SITE_NAME}
  description={SITE_DESCRIPTION}
>
  <div class="container py-8 md:py-12">
    {/* Featured article */}
    {featured && (
      <section class="mb-10">
        <a href={`/${getCategoryMeta(featured.data.category as CategoryKey).slug}/${featured.id}`} class="block border border-[var(--color-border)] rounded-xl p-6 md:p-8 hover:border-[var(--color-muted)] transition-colors">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-xs font-bold uppercase tracking-wider text-[var(--color-accent)]">Breaking</span>
            {featured.data.severity && ['critical', 'high'].includes(featured.data.severity) && (
              <span class={`text-xs font-medium px-2 py-0.5 rounded-full uppercase badge-severity-${featured.data.severity}`}>
                {featured.data.severity}
              </span>
            )}
          </div>
          <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold mb-3 leading-tight">{featured.data.title}</h1>
          <p class="text-lg text-[var(--color-muted)] mb-4 max-w-3xl">{featured.data.summary}</p>
          <div class="flex items-center gap-2 text-sm text-[var(--color-muted)]">
            <span class="font-medium">{featured.data.sourceAgency}</span>
            <span>&middot;</span>
            <span>{new Date(featured.data.publishedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
            {featured.data.location && (
              <>
                <span>&middot;</span>
                <span>{featured.data.location}</span>
              </>
            )}
          </div>
        </a>
      </section>
    )}

    {/* City Data Section */}
    <section class="mb-10 border border-[var(--color-border)] rounded-xl p-6 md:p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <div>
          <h2 class="text-xl md:text-2xl font-bold mb-1">City Data Reports</h2>
          <p class="text-sm text-[var(--color-muted)]">
            {fmt(totalCities)} cities covering {fmtCompact(totalPop)} residents — population, income, health, and hospitals.
          </p>
        </div>
        <a href="/cities" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium border border-[var(--color-border)] rounded-lg hover:bg-[var(--color-card)] transition-colors flex-shrink-0">
          Search all cities &rarr;
        </a>
      </div>

      {/* National Snapshot */}
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <div class="stat-card" style="--accent: var(--color-data-blue)">
          <div class="data-label">Cities Tracked</div>
          <div class="data-value">{fmtCompact(totalCities)}</div>
        </div>
        <div class="stat-card" style="--accent: var(--color-data-teal)">
          <div class="data-label">Natl Median Income</div>
          <div class="data-value">{fmtMoney(nationalStats.avgMedianIncome)}</div>
        </div>
        <div class="stat-card" style="--accent: var(--color-data-amber)">
          <div class="data-label">Natl Median Home</div>
          <div class="data-value">{fmtMoney(nationalStats.avgMedianHomeValue)}</div>
        </div>
        <div class="stat-card" style="--accent: var(--color-data-violet)">
          <div class="data-label">Data Sources</div>
          <div class="data-value">3</div>
          <div class="text-xs text-[var(--color-muted)] mt-0.5">Census, CDC, CMS</div>
        </div>
      </div>

      {/* Top Cities Quick Links */}
      <div class="flex flex-wrap gap-2">
        {topCities.map(city => (
          <a
            href={`/cities/${city.slug}`}
            class="text-sm px-3 py-1.5 border border-[var(--color-border)] rounded-full hover:border-[var(--color-muted)] hover:bg-[var(--color-card)] transition-colors flex items-center gap-2"
          >
            <span>{city.name}</span>
            <span class="text-xs text-[var(--color-muted)] tabular-nums">{fmtCompact(city.population)}</span>
          </a>
        ))}
        <a
          href="/cities"
          class="text-sm px-3 py-1.5 text-[var(--color-accent)] hover:underline flex items-center"
        >
          View all {fmtCompact(totalCities)} cities &rarr;
        </a>
      </div>

      {/* State Links */}
      <div class="mt-4 pt-4 border-t border-[var(--color-border)] flex items-center gap-2 flex-wrap">
        <span class="text-xs text-[var(--color-muted)] font-medium uppercase tracking-wider">By state:</span>
        <a href="/states" class="text-sm text-[var(--color-accent)] hover:underline">All 50 states + DC &rarr;</a>
      </div>
    </section>

    {/* Category sections — 2-3 columns */}
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
      {categorySections.map(section => (
        <div>
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-sm font-bold uppercase tracking-wider" style={`color: ${section.color}`}>{section.label}</h2>
            <a href={section.href} class="text-xs text-[var(--color-muted)] hover:text-[var(--color-foreground)]">View all</a>
          </div>
          <div class="space-y-3">
            {section.articles.slice(0, 4).map(article => (
              <ArticleCard
                title={article.data.title}
                summary={article.data.summary}
                href={`/${getCategoryMeta(article.data.category as CategoryKey).slug}/${article.id}`}
                category={article.data.category as CategoryKey}
                sourceAgency={article.data.sourceAgency}
                publishedAt={new Date(article.data.publishedAt)}
                severity={article.data.severity}
              />
            ))}
          </div>
        </div>
      ))}
    </div>

    {/* Latest articles across all categories */}
    <section class="border-t border-[var(--color-border)] pt-8 mb-12">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold">Latest</h2>
        <a href="/articles" class="text-sm text-[var(--color-muted)] hover:text-[var(--color-foreground)]">View all &rarr;</a>
      </div>
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {latest.map(article => (
          <ArticleCard
            title={article.data.title}
            summary={article.data.summary}
            href={`/${getCategoryMeta(article.data.category as CategoryKey).slug}/${article.id}`}
            category={article.data.category as CategoryKey}
            sourceAgency={article.data.sourceAgency}
            publishedAt={new Date(article.data.publishedAt)}
            severity={article.data.severity}
          />
        ))}
      </div>
    </section>

    {/* About blurb */}
    <section class="border-t border-[var(--color-border)] pt-8">
      <div class="max-w-2xl">
        <h2 class="text-lg font-bold mb-2">About Areazine</h2>
        <p class="text-[var(--color-muted)]">
          We transform U.S. government public data into clear, readable news. Every article links back to its original government source. No paywalls, no ads — just the information you need.
        </p>
        <a href="/about" class="inline-block mt-3 text-sm font-medium text-[var(--color-accent)] hover:underline">
          Learn more about our methodology &rarr;
        </a>
      </div>
    </section>
  </div>

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": SITE_NAME,
    "description": SITE_DESCRIPTION,
    "url": "https://areazine.com",
    "potentialAction": {
      "@type": "SearchAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": "https://areazine.com/articles?q={search_term_string}"
      },
      "query-input": "required name=search_term_string"
    }
  })} />

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": SITE_NAME,
    "url": "https://areazine.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://areazine.com/logo.png",
      "width": 512,
      "height": 512
    },
    "description": SITE_DESCRIPTION,
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "customer service",
      "email": "hello@areazine.com"
    }
  })} />
</Base>
