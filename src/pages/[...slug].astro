---
import Base from '../layouts/Base.astro';
import { getCollection, render } from 'astro:content';
import { getCategoryMeta, formatDate, SITE_NAME } from '../lib/config';
import type { CategoryKey } from '../lib/config';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  return articles.map(article => {
    const catMeta = getCategoryMeta(article.data.category as CategoryKey);
    return {
      params: { slug: `${catMeta.slug}/${article.id}` },
      props: { article },
    };
  });
}

const { article } = Astro.props;
const { Content } = await render(article);
const catMeta = getCategoryMeta(article.data.category as CategoryKey);
const publishedDate = formatDate(new Date(article.data.publishedAt));

const allArticles = await getCollection('articles');
const related = allArticles
  .filter(a => a.data.category === article.data.category && a.id !== article.id)
  .sort((a, b) => new Date(b.data.publishedAt).getTime() - new Date(a.data.publishedAt).getTime())
  .slice(0, 3);
---

<Base
  title={article.data.title}
  description={article.data.summary}
  article={true}
  publishedTime={new Date(article.data.publishedAt).toISOString()}
  section={catMeta.label}
  tags={article.data.tags}
>
  <article class="py-8 md:py-12">
    <div class="container-narrow">
      <nav class="flex items-center gap-2 text-sm text-[var(--color-muted)] mb-6">
        <a href="/" class="hover:text-[var(--color-foreground)]">Home</a>
        <span>/</span>
        <a href={`/${catMeta.slug}`} class="hover:text-[var(--color-foreground)]">{catMeta.label}</a>
      </nav>

      <header class="mb-8">
        <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold mb-4 leading-tight">{article.data.title}</h1>

        <div class="flex flex-wrap items-center gap-3 text-sm text-[var(--color-muted)]">
          <span class={`text-xs font-medium px-2.5 py-1 rounded-full badge-${catMeta.color}`}>
            {catMeta.label}
          </span>
          {article.data.severity && (
            <span class={`text-xs font-medium px-2.5 py-1 rounded-full uppercase badge-severity-${article.data.severity}`}>
              {article.data.severity}
            </span>
          )}
          <span>{article.data.sourceAgency}</span>
          <span>&middot;</span>
          <time datetime={new Date(article.data.publishedAt).toISOString()}>{publishedDate}</time>
          {article.data.location && (
            <>
              <span>&middot;</span>
              <span>{article.data.location}</span>
            </>
          )}
        </div>
      </header>

      <p class="text-lg text-[var(--color-muted)] mb-8 pb-8 border-b border-[var(--color-border)]">
        {article.data.summary}
      </p>

      <div class="prose">
        <Content />
      </div>

      <div class="mt-8 pt-6 border-t border-[var(--color-border)]">
        <p class="text-sm text-[var(--color-muted)]">
          Source: <a href={article.data.sourceUrl} target="_blank" rel="noopener noreferrer" class="text-[var(--color-accent)] hover:underline">{article.data.sourceAgency} Official Notice</a>
        </p>
      </div>

      {related.length > 0 && (
        <div class="mt-12 pt-8 border-t border-[var(--color-border)]">
          <h2 class="text-lg font-bold mb-4">Related Articles</h2>
          <div class="space-y-3">
            {related.map(rel => (
              <a href={`/${getCategoryMeta(rel.data.category as CategoryKey).slug}/${rel.id}`} class="block p-4 border border-[var(--color-border)] rounded-lg hover:border-[var(--color-muted)] transition-colors">
                <h3 class="font-semibold mb-1">{rel.data.title}</h3>
                <p class="text-sm text-[var(--color-muted)]">
                  {rel.data.sourceAgency} &middot; {formatDate(new Date(rel.data.publishedAt))}
                </p>
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
  </article>

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "NewsArticle",
    "headline": article.data.title,
    "description": article.data.summary,
    "image": "https://areazine.com/logo.png",
    "datePublished": new Date(article.data.publishedAt).toISOString(),
    "dateModified": article.data.updatedAt ? new Date(article.data.updatedAt).toISOString() : new Date(article.data.publishedAt).toISOString(),
    "author": {
      "@type": "Organization",
      "name": SITE_NAME,
      "url": "https://areazine.com"
    },
    "publisher": {
      "@type": "Organization",
      "name": SITE_NAME,
      "url": "https://areazine.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://areazine.com/logo.png",
        "width": 512,
        "height": 512
      }
    },
    "mainEntityOfPage": { "@type": "WebPage", "@id": `https://areazine.com/${catMeta.slug}/${article.id}` }
  })} />

  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      { "@type": "ListItem", "position": 1, "name": "Home", "item": "https://areazine.com/" },
      { "@type": "ListItem", "position": 2, "name": catMeta.label, "item": `https://areazine.com/${catMeta.slug}/` },
      { "@type": "ListItem", "position": 3, "name": article.data.title }
    ]
  })} />
</Base>
